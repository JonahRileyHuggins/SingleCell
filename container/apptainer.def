Bootstrap: docker
From: ubuntu:24.04

%files
    ${PWD} /SingleCell

%post
    export DEBIAN_FRONTEND=noninteractive
    export SHELL=/bin/bash

    apt-get update && apt-get install -y --no-install-recommends \
        build-essential \
        ninja-build \
        curl \
        wget \
        git \
        cmake \
        swig \
        gfortran \
        libgomp1 \
        gcc-14 \
        g++-14 \
        libboost-all-dev \
        libopenblas-dev \
        libhdf5-dev \
        libxml2-dev \
        python3 \
        python3-dev \
        python3-pip \
        python3-venv \
        vim nano dos2unix \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

    # Ensure python is available as "python"
    ln -s /usr/bin/python3 /usr/bin/python

    # Fix scripts and perms
    cd /SingleCell
    find . -type f -name "*.sh" -exec dos2unix {} \; -exec chmod +x {} \;

    # Run project installer
    chmod +x ./Install.sh
    ./Install.sh

    # Build libsbml
    cd ~/.local/share/SingleCell/extern/libsbml/
    cmake -B build \
    && cmake --build build/ --parallel \
    && cmake --install build/

    # Build amici deps
    cd ~/.local/share/SingleCell/extern/AMICI/scripts/
    bash ./buildSuiteSparse.sh
    bash ./buildSundials.sh
    bash ./buildAmici.sh

%environment
    export PATH=/root/.local/bin:$PATH
    export BLAS_LIBS=-lopenblas
    export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH

%runscript
    exec SingleCell --help

%startscript
    exec SingleCell --help

%help
    This container enables cross-platform installation of SingleCell tools.
