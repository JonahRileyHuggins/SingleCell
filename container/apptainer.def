Bootstrap: docker
From: python:3.12-slim

%files
    ### Modify line 6, columns 9:14 to local SingleCell directory
    ${PWD} /SingleCell ### Change This Line, note the two separate paths (source \space dest)
    #!!^changeme-->^^^^^^^^Don't Delete Me :'(

%post
 
    # Set shell and environment
    export DEBIAN_FRONTEND=noninteractive
    export SHELL=/bin/bash

    # Export variables for the build process
    export BLAS_LIBS=-lopenblas
    export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH

    # Update and install basic dependencies
    apt-get update && apt-get install -y --no-install-recommends \
        build-essential \
        ninja-build \
        curl \
        wget \
        libboost-all-dev \
        libopenblas-dev \
        gcc \
        g++ \
        git \
        gfortran \
        cmake \
        swig \
        pipx \
        libhdf5-dev \
        libxml2-dev \
        vim nano curl wget dos2unix \
    && apt-get clean && rm -rf /var/lib/apt/lists/*

    # Ensure owner permissions for /SingleCell
    chmod -R 777 /SingleCell
    chown -R root:root /SingleCell

    # Ubuntu 24.04 doesn't symlink python to python3 by default:
    ln -s /usr/bin/python3 /usr/bin/python

    cd /SingleCell
    find . -type f -name "*.sh" -exec dos2unix {} \; \
    && find . -type f -name "*.sh" -exec chmod +x {} \;

    # Install Python Dependencies
    cd /SingleCell
    chmod +x ./Install.sh
    ./Install.sh

    # preinstall libsbml at local user site
    # Note: directory made in 
    cd ~/.local/share/SingleCell/extern/libsbml/ 
    cmake -B build \
    && cmake --build build/ --parallel \
    && cmake --install build/

    # preinstall AMICI
    cd ~/.local/share/SingleCell/extern/AMICI/scripts/
    bash ./buildSuiteSparse.sh
    bash ./buildSundials.sh
    bash ./buildAmici.sh

%environment
    # Set up runtime environment variables
    export PATH=/root/.local/bin:$PATH
    export BLAS_LIBS=-lopenblas
    export LD_LIBRARY_PATH=/usr/local/lib:$LD_LIBRARY_PATH

%runscript
    # Default command for the container
    exec SingleCell --help

%startscript
    exec SingleCell --help

%help
    This container enables cross-platform installation of SingleCell tools.
    Concerns and questions should be posted directly on our project
    Repository page at TO BE FILLED IN LATER.
